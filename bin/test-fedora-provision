#!/bin/sh

# Provision new Samba Active Directory Controller with Fedora.

# Make lvm user owned???  This seems to work...
# cat /etc/udev/rules.d/99-custom.rules
#ENV{DM_NAME}=="testnonroot", ACTION=="add|change", MODE="0664", OWNER="lochnerr", GROUP="disk", PROGRAM="/bin/logger /dev/$env{DM_NAME} owner changed to lochnerr"

#hostnamectl hostname dc1.clone1.com
#hostnamectl


# 1) Set vars.

DOMAIN="$(hostname -d)"
REALM="$(echo $DOMAIN | tr 'a-z' 'A-Z')"
HOST_IP="$(ip route get 8.8.8.8 | awk -F'src ' 'NR==1{split($2,a," ");print a[1]}')"
PASSWORD="Passw0rd"
WORKGROUP="CLONE1"

echo "Host:      $(hostname -s)"
echo "Domain:    $DOMAIN"
echo "Realm:     $REALM"
echo "Host Addr: $HOST_IP"
echo "WORKGROUP: $WORKGROUP"

# 2) Fix systemd-resolved.

mkdir -p /usr/lib/systemd/resolved.conf.d

cat <<-__EOF__ >/usr/lib/systemd/resolved.conf.d/samba-dc.conf
	[Resolve]
	DNSStubListener=no
	Domains=${DOMAIN}
	DNS=${HOST_IP}
	__EOF__

systemctl restart systemd-resolved

# 3) Provision
[ ! -e /etc/samba/smb.conf.bak ] && mv /etc/samba/smb.conf /etc/samba/smb.conf.bak

samba-tool domain provision --server-role=dc --use-rfc2307 --dns-backend=SAMBA_INTERNAL --realm=${REALM} --domain=${WORKGROUP} --adminpass=${PASSWORD}

# 4) Fix krb5.conf

# Copy the original krb5.conf file to the drop-ins directory.
cp --preserve=context /etc/krb5.conf /etc/krb5.conf.d/samba-dc

# Pipe the samba generated file over the original conf file to preserve its SELinux context.
cat /var/lib/samba/private/krb5.conf >/etc/krb5.conf.d/samba-dc

# 5) Start samba dc.

systemctl enable samba
systemctl start samba

sleep 2s
systemctl status samba

