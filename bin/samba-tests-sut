#!/bin/sh

# samba-tests-sut: System Unit Tests for automated Docker build.

run_tests() {

  HOST_NAME="$1"
  HOST_IP="$2"

  echo "Running tests for $HOST_NAME at address ${HOST_IP}."

  # Update the resolv.conf file to point to the master or slave.
  cat > /etc/resolv.conf <<-__EOF__
	search $DOMAIN
	nameserver ${HOST_IP}
	__EOF__

  file="/var/lib/samba/samba-status"
  [ "$HOST_NAME" = "test-slave" ] && file="/var/lib/slave/samba-status"

  # Wait up to 6 minutes for server to come up.
  for try in $(seq -s ' ' 1 24) ; do
    if [ -e $file ]; then
      echo "$HOST_NAME is up!"
      test_samba
      break
    fi
    sleep 15;
    echo "Waiting for ${HOST_NAME} to become ready ($try)."
  done
  test_stats
}

# Get the master and slave IP's from docker's internal dns.
MASTER_IP="$(host -t A test-master | grep 'has address' | cut -d ' ' -f 4)"
SLAVE_IP="$(host -t A test-slave | grep 'has address' | cut -d ' ' -f 4)"

# Set the global vars.
. samba-set-vars
set_samba_vars

# Update the kerberos config.
cat >/etc/krb5.conf <<-__EOF__
	[libdefaults]
	     default_realm = $REALM
	     dns_lookup_realm = false
	     dns_lookup_kdc = true
	__EOF__

# Source the test functions.
. samba-tests

# Test the master.
run_tests test-master $MASTER_IP

# Test the slave.
run_tests test-slave $SLAVE_IP

# Signal shutdown for master and slave.
touch /var/lib/samba/shutdown-request
touch /var/lib/slave/shutdown-request

# It can take up to 15 seconds for services to shut down.
sleep 15s

rc="0"
if [ "$errs" != "0" ]; then
  echo "Error: Manditory tests failed."
  rc="1"
fi

echo "Exiting!"

exit $rc

