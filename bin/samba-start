#!/bin/sh

# samba-start - Provision and/or start samba domain controller.

set -e

start_service() {

  if [ -n "$SYSTEMD" ]; then
    systemctl start $1
  else
    if [ "$1" = "named" ]; then
      echo "named -u $NAMED_USER $LOG_OPTIONS"
      # Temporary code for Alpine testing.
      [ -e /sbin/apk ] && valgrind="valgrind --trace-children=yes --log-file=/root/named-vg.txt"
      if ! $valgrind named -u $NAMED_USER $LOG_OPTIONS ; then
        echo "Named startup failed!"
        ps aux | grep -i [Nn]amed
      fi
    else
      $1
    fi
  fi
}

stop_service() {

  if [ -n "$SYSTEMD" ]; then
    systemctl stop $1 || true
  else
    pidfile="/run/$1/$1.pid"
    [ -e /run/$1.pid ] && pidfile="/run/$1.pid"
    [ -e $pidfile ] && kill "$(cat $pidfile)" || true
  fi
}

# Note: This is also used by samba provisioning.
fixup_smb_config() {
  if [ "$BACKEND" = "BIND9_DLZ" ]; then
    # BIND9_DLZ, disable samba dns service.
    sed -i \
      -e "s:, dns$::" \
      -e "s:[^#]dns forwarder:\t#dns forwarder:" \
      /etc/samba/smb.conf
  else
    # SAMBA_INTERNAL, enable samba dns service.
    sed -i \
      -e "s:dnsupdate$:dnsupdate, dns:" \
      -e "s:#dns forwarder:dns forwarder:" \
      /etc/samba/smb.conf
    # samba_upgradedns deletes the dns user when changing to SAMBA_INTERNAL and creates a
    # new user when upgrading to BIND9_DLZ.  So, delete obsolete keytab if upgrading to SAMBA_INTERNAL.
    # A new one will be created if the domain is upgraded later back to BIND9_DLZ.
    if [ -e $PRIVATE_DIR/dns.keytab ]; then
      echo "Deleting obsolete dns.keytab file."
      rm $PRIVATE_DIR/dns.keytab
    fi
  fi
}

update_named_root_servers() {

  if [ -z "$NAMED_ROOT_ONCE" ]; then
    # Update the named root servers.
    wget https://www.internic.net/zones/named.cache.md5 || touch named.cache.md5
    wget https://www.internic.net/zones/named.cache || touch named.cache
    NAMED_ROOT_CHANGED=""
    # Make sure the checksum is good before doing anything with the file.
    if [ "$(cat named.cache.md5)" = "$(md5sum named.cache | cut -d ' ' -f1 )" ]; then
      NAMED_ROOT_ONCE="true"
      touch /var/named/named.root
      # Only update the named root list if it has changed.
      if ! diff named.cache /var/named/named.root >/dev/null; then
        echo "Named root server list has changed."
        cp -a named.cache /var/named/named.root
        chown ${NAMED_USER}:${NAMED_GROUP} /var/named/named.root
        NAMED_ROOT_CHANGED="true"
      else
        echo "Named root server list has not changed, no need to update!"
      fi
    fi
    rm named.cache.md5
    rm named.cache
  fi
}

start_bind() {

  # See: https://wiki.samba.org/index.php/Setting_up_a_BIND_DNS_Server

  echo "Starting named."

  chown root:$NAMED_GROUP /etc/krb5.conf

  # This is needed for Debian/Ubuntu.
  mkdir -p /run/named
  chown ${NAMED_USER}:${NAMED_GROUP} /run/named

  # Copy the persistent named.conf to the usual places.
  cp -a /var/named/named.conf /etc/
  [ -d /etc/bind ]   && cp -a /var/named/named.conf /etc/bind/
  [ -d /etc/named ]  && cp -a /var/named/named.conf /etc/named/

  # Copy the persistent rndc.key to the usual places.
  cp -a /var/named/rndc.key /etc/
  mkdir -p /etc/bind
  cp -a /var/named/rndc.key /etc/bind/

  echo "named-checkconf"
  named-checkconf

  [ -n "$BIND_LOG_LEVEL" ] && LOG_OPTIONS="-d $BIND_LOG_LEVEL"

  # Start bind.
  if [ -e /etc/sysconfig/named ]; then
    # Fix Fedora named option.  This prevents "replay errors" and is critical for nsupdate to work.
    if [ -z "$(grep KRB5RCACHETYPE /etc/sysconfig/named)" ]; then
      echo "Setting KRB5RCACHETYPE='none' in /etc/sysconfig/named."
      echo 'KRB5RCACHETYPE="none"' >> /etc/sysconfig/named
    fi
  fi

  # Go ahead and export this.  It is only needed for MIT Kerberos, but it is harmless otherwise.
  # See: https://bugzilla.samba.org/show_bug.cgi?id=13066
  export KRB5RCACHETYPE="none"

  if [ -e /sbin/apk ]; then
    # TODO Temporary code for Alpine testing.
    sed -i 's:/bind9/dlz_bind9_11.so";:/bind9/dlz_bind9_11.so -d 5";:' ${BINDDNS_DIR}/named.conf
    sed -i 's:/bind9/dlz_bind9_12.so";:/bind9/dlz_bind9_12.so -d 5";:' ${BINDDNS_DIR}/named.conf
    chown ${NAMED_USER}:${NAMED_GROUP} ${BINDDNS_DIR}/named.conf
  fi
  start_service named

  # Wait for named to fully start.
  sleep 3s

  # Update the list of root servers.
  update_named_root_servers
  if [ -n "$NAMED_ROOT_CHANGED" ]; then
    echo "Restarting named to reload root servers."
    stop_service named
    sleep 2s
    start_service named
    sleep 5s
  fi

  # Verify named is responding to queries.
  if ! host -t A localhost $HOST_IP ; then
    echo "WARNING: named is not responding."
  fi
}

set_server_status() {

  echo "Setting server status to $1."
  echo "$1" > /var/lib/samba/samba-status
}

# Start

echo "$(date '+%y-%m-%d %H:%M:%S') Starting Samba Active Directory Domain Controller."

# Indicates to system unit test that the server is starting.
set_server_status "Starting"

# Delete files used by system unit test.
[ -e /var/lib/samba/shutdown-request ] && rm -f /var/lib/samba/shutdown-request

# Determine if we are running under init system (systemd or openRC).
if [ -n "$(ps aux | egrep '([ ]*[ ]1[ ]*root|root.*[ ]1[ ])' | grep /sbin/init)" ]; then
  echo "Running under systemd or openRC."
  SYSTEMD="true"
fi

if [ -e /sbin/apk ]; then
  echo "Starting syslog in Alpine."
  syslogd
  echo "Forcing backend to SAMBA_INTERNAL for Alpine Linux."
  BACKEND="SAMBA_INTERNAL"
fi

. samba-set-vars
set_samba_vars

# Create a persistent config directory.
if [ ! -d ${STATEDIR}/config ]; then
  echo "Creating persistent config directory in ${STATEDIR}."
  mkdir -p ${STATEDIR}/config
  cp -a /etc/samba/. ${STATEDIR}/config
fi

# Link /etc/samba to the persistent config directory.
if [ ! -L "/etc/samba" ]; then
  echo "Linking /etc/samba to the persistent config directory."
  [ -d /etc/samba ] && mv /etc/samba /etc/samba-bak
  ln -s ${STATEDIR}/config /etc/samba
else
  # This will happen if the container is (re)started without being removed first (e.g. docker-compose up).
  echo "/etc/samba already linked."
fi

# Create a persistent named directory.
if [ ! -d ${STATEDIR}/named ]; then
  echo "Creating persistent named directory in ${STATEDIR}."
  mkdir -p ${STATEDIR}/named
  [ -e /var/named ] && cp -a /var/named/. ${STATEDIR}/named
  [ -e /var/bind ]  && cp -a /var/bind/.  ${STATEDIR}/named
  chown $NAMED_USER:$NAMED_GROUP ${STATEDIR}/named
fi

# Link /var/named to the persistent directory.
if [ ! -L "/var/named" ]; then
  echo "Linking /var/named to the persistent directory."
  [ -d /var/named ] && mv /var/named /var/named-bak
  ln -s ${STATEDIR}/named /var/named
else
  # This will happen if the container is (re)started without being removed first (e.g. docker-compose up).
  echo "/var/named already linked."
fi

# Set the local timezone.
if [ -n "$TIMEZONE" ]; then
  if [ -e /usr/share/zoneinfo/$TIMEZONE ]; then
    echo "Setting timezone to ${TIMEZONE}."
    ln -fs /usr/share/zoneinfo/$TIMEZONE /etc/localtime
  else
    echo "Timezone ${TIMEZONE} not found, not changing timezone."
  fi
fi

# The following are the configuration steps as described in
# https://wiki.samba.org/index.php/Setting_up_Samba_as_an_Active_Directory_Domain_Controller

# Step 1: Preparing the Installation

# Update the hosts file.
cat > /etc/hosts <<-__EOF__
	127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
	::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
	$HOST_IP    ${HOST_NAME}.$DOMAIN ${HOST_NAME}
	__EOF__

# Step 2: Installing Samba --- Not needed, already installed.

# Step 3: Provisioning Samba AD in Non-Interactive Mode (First run only).
if [ ! -f $PRIVATE_DIR/secrets.tdb ]; then
  . samba-provisioning
  save_backend="$BACKEND"
  if [ "$ROLE" != "master" ]; then
    if [ "$BACKEND" = "BIND9_DLZ" ]; then
      # Domain join with BIND9_DLZ incorrectly creates the dns account.
      # See: https://bugzilla.samba.org/show_bug.cgi?id=13926
      echo "Forcing domain join to use SAMBA_INTERNAL backend."
      echo "Backend will be upgraded to BIND9_DLZ after the join."
      BACKEND="SAMBA_INTERNAL"
    fi
  fi
  provision
  BACKEND="$save_backend"
  # Create a bind config even if using SAMBA_INTERNAL backend.
  # This will allow switching to BIND9_DLZ at a later time.
  setup_bind_config
  PROVISIONED="true"
fi

# Step 7 (Out of order from docs): Configuring Kerberos
# This needs to be done before doing a samba_upgradedns.

cp -a $PRIVATE_DIR/krb5.conf /etc/
chmod 0644 /etc/krb5.conf

# Step 4: Setting up the AD DNS back end

# If the dns backend has changed, a samba dns upgrade is required.
if [ "$BACKEND" != "$(cat /etc/samba/backend  || true)" ]; then
  echo "DNS backend changed to: ${BACKEND}."
  fixup_smb_config
  samba_upgradedns --dns-backend=$BACKEND
  echo "$BACKEND" >/etc/samba/backend
fi

# If using bind backend, start bind.
[ "$BACKEND" = "BIND9_DLZ" ] && start_bind

# Step 5: Configuring the DNS Resolver

# Update the resolv.conf file.
cat > /etc/resolv.conf <<-__EOF__
	search $DOMAIN
	nameserver ${HOST_IP}
	__EOF__

# Step 8: Testing your Samba AD DC

echo "Starting samba."
if [ -n "$SYSTEMD" ]; then
  systemctl start samba
else
  samba
fi
echo "Samba started."

# Wait for samba to start.
sleep 3s

[ "$PROVISIONED" = "true" ] && post_provisioning

if [ "$(echo $RUN_TESTS | tr [a-z] [A-Z])" = "TRUE" ]; then
  . samba-tests
  test_samba
  test_stats
fi

echo "$(date '+%y-%m-%d %H:%M:%S') Done!"

# Indicates to system unit test that the server is ready.
set_server_status "Running"

# Check for shutdown request from system unit test.
while : ; do
  sleep 15s
  if [ -e /var/lib/samba/shutdown-request ]; then
    set_server_status "Shutting Down"
    stop_service samba
    [ "$BACKEND" = "BIND9_DLZ" ] && stop_service named
    break
  fi
done

set_server_status "Stopped"

echo "Exiting!"

exit 0

