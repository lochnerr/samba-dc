#!/bin/sh

# samba-configure: Build time configuration for samba-dc.

samba_configure() {

  . /etc/os-release

  case $ID in
  fedora)
    # Enable the systemd samba service.
    systemctl enable samba-ad-dc.service
    # This prevents a spurious error message in the logs when running in fedora.
    mkdir -p /etc/rc.d/init.d
    touch /etc/rc.d/init.d/functions
    ;;
  ubuntu)
    rm /etc/systemd/system/multi-user.target.wants/cron.service
    rm /etc/systemd/system/multi-user.target.wants/bind9.service
    rm /etc/systemd/system/multi-user.target.wants/networkd-dispatcher.service
    rm /etc/systemd/system/multi-user.target.wants/nmbd.service
    rm /etc/systemd/system/multi-user.target.wants/ondemand.service
    rm /etc/systemd/system/multi-user.target.wants/remote-fs.target
    rm /etc/systemd/system/multi-user.target.wants/smbd.service
    rm /lib/systemd/system/multi-user.target.wants/systemd-logind.service
    rm /etc/systemd/system/multi-user.target.wants/systemd-resolved.service
    rm /etc/systemd/system/multi-user.target.wants/winbind.service
    rm /lib/systemd/system/multi-user.target.wants/dbus.service
    rm /lib/systemd/system/sockets.target.wants/dbus.socket
    rm /etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service
    ln -s /etc/systemd/system/samba-runner.service /lib/systemd/system/multi-user.target.wants/samba-runner.service
    ;;
  alpine)
    # Enable the samba service and disable other unnecessary services.
    sed -i 's/^tty/#tty/' /etc/inittab \
    sed -i 's/#daemon_list="samba"/daemon_list="samba"/' /etc/conf.d/samba
    ln -sf /etc/init.d/samba-ad-dc /etc/runlevels/default/syslog
    ln -sf /etc/init.d/samba-ad-dc /etc/runlevels/default/samba-ad-dc
    ;;
  esac

  # Link /etc/samba to the persistent config directory.

  STATEDIR="/var/lib/samba"
  echo "Linking /etc/samba to the persistent config directory."
  [ -d /etc/samba ] && mv /etc/samba /etc/samba-bak
  ln -s ${STATEDIR}/config /etc/samba

  echo "Linking /var/named to the persistent directory."
  [ -d /var/named ] && mv /var/named /var/named-bak
  ln -s ${STATEDIR}/named /var/named
}

